import { ImageResponse, NextRequest } from 'next/server';

export const runtime = 'edge';

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url as string);
  const title = searchParams.get('title');
  const username = searchParams.get('username');

  if (!title || !username) throw new Error('Error generating image');

  let arr = title.split(' ');

  let text: string = '';

  if (arr.length > 20) {
    text = `${arr.slice(0, 20).join(' ')}...`;
  }

  return new ImageResponse(
    (
      <div
        style={{
          width: '100%',
          height: '100%',
          backgroundColor: '#030711',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          position: 'relative',
        }}
      >
        <div
          style={{
            display: 'flex',
            width: '100%',
            maxWidth: 1100,
            flexDirection: 'column',
            gap: '30px',
            alignItems: 'center',
            justifyContent: 'center',
            margin: 'auto',
            maxHeight: '580px',
            overflow: 'hidden',
          }}
        >
          <div
            style={{
              width: '100%',
              display: 'flex',
            }}
          >
            <div
              style={{
                display: 'flex',
                width: '160px',
                height: '48px',
              }}
            >
              <svg
                width="160"
                height="49"
                viewBox="0 0 160 49"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M47.8669 43.1667C47.8669 44.5812 47.3065 45.9377 46.3091 46.9379C45.3117 47.9381 43.9589 48.5 42.5483 48.5H5.31854C3.90798 48.5 2.55519 47.9381 1.55777 46.9379C0.560346 45.9377 0 44.5812 0 43.1667V5.83333C0 4.41885 0.560346 3.06229 1.55777 2.0621C2.55519 1.0619 3.90798 0.5 5.31854 0.5H42.5483C43.9589 0.5 45.3117 1.0619 46.3091 2.0621C47.3065 3.06229 47.8669 4.41885 47.8669 5.83333V43.1667Z"
                  fill="#2C5EA8"
                />
                <path
                  d="M20.0602 27.6733H27.8931L24.0598 15.6839H23.9773L20.0602 27.6733ZM19.6068 12.6653C20.3089 10.7639 21.9164 9.2346 24.0186 9.2346C26.2031 9.2346 27.7296 10.6813 28.429 12.6653L36.5105 35.1546C36.7565 35.8159 36.8402 36.3959 36.8402 36.6853C36.8402 38.2973 35.5199 39.4133 33.9961 39.4133C32.2636 39.4133 31.398 38.5039 30.9858 37.2639L29.7493 33.3773H18.2878L17.0513 37.2226C16.6391 38.5039 15.7722 39.4133 14.0822 39.4133C12.4334 39.4133 11.032 38.1733 11.032 36.5199C11.032 35.8586 11.2381 35.3626 11.3205 35.1546L19.6068 12.6653Z"
                  fill="white"
                />
                <path
                  d="M62.1338 38.9762L71.1337 14.6494H75.4645L84.4814 38.9762H80.6581L78.6619 33.4119H67.9533L65.9401 38.9762H62.1338ZM69.1206 30.1208H77.4777L73.3837 18.8226H73.2145L69.1206 30.1208Z"
                  fill="#D7E3FF"
                />
                <path
                  d="M92.5848 39.3155C90.5773 39.3155 88.9476 38.6369 87.6957 37.2798C86.4551 35.9113 85.8348 34.1018 85.8348 31.8512V20.5699H89.1337V31.6815C89.1337 33.1179 89.5115 34.2318 90.2671 35.0235C91.034 35.8039 92.0378 36.194 93.2784 36.194C94.5528 36.194 95.6243 35.7473 96.4927 34.8539C97.3611 33.9604 97.7953 32.903 97.7953 31.6815V20.5699H101.077V38.9762H98.4889L97.9645 36.5503H97.7953C96.6562 38.3937 94.9194 39.3155 92.5848 39.3155Z"
                  fill="#D7E3FF"
                />
                <path
                  d="M113.038 36.194C114.583 36.194 115.835 35.6455 116.793 34.5485C117.763 33.4515 118.248 31.8625 118.248 29.7815C118.248 27.6893 117.769 26.0946 116.81 24.9976C115.852 23.8893 114.594 23.3351 113.038 23.3351C111.515 23.3351 110.297 23.8836 109.384 24.9807C108.47 26.0664 108.013 27.6667 108.013 29.7815C108.013 31.8851 108.47 33.4798 109.384 34.5655C110.297 35.6512 111.515 36.194 113.038 36.194ZM112.53 39.3155C110.196 39.3155 108.312 38.4842 106.88 36.8217C105.448 35.1592 104.731 32.8068 104.731 29.7646C104.731 26.711 105.459 24.3586 106.914 22.7074C108.369 21.0449 110.297 20.2137 112.699 20.2137C114.989 20.2137 116.776 21.0845 118.062 22.8262H118.248V14.6494H121.53V38.9762H118.942L118.417 36.5503H118.248C116.816 38.3937 114.91 39.3155 112.53 39.3155Z"
                  fill="#D7E3FF"
                />
                <path
                  d="M133.998 39.3155C131.37 39.3155 129.267 38.4729 127.688 36.7878C126.12 35.0914 125.337 32.7503 125.337 29.7646C125.337 26.7789 126.109 24.4435 127.654 22.7583C129.199 21.0619 131.258 20.2137 133.829 20.2137C136.434 20.2137 138.498 21.0958 140.021 22.8601C141.543 24.6131 142.305 26.6262 142.305 28.8994L142.135 30.8164H128.771C128.861 32.5354 129.38 33.8643 130.327 34.803C131.275 35.7304 132.498 36.194 133.998 36.194C135.893 36.194 137.337 35.442 138.329 33.9378H141.966C141.346 35.5551 140.342 36.8557 138.955 37.8396C137.568 38.8235 135.915 39.3155 133.998 39.3155ZM128.771 28.0342H138.921C138.718 26.5527 138.165 25.3991 137.263 24.5735C136.361 23.7479 135.216 23.3351 133.829 23.3351C132.442 23.3351 131.297 23.7479 130.395 24.5735C129.493 25.3991 128.951 26.5527 128.771 28.0342Z"
                  fill="#D7E3FF"
                />
                <path
                  d="M151.677 36.3637C153.199 36.3637 154.417 35.9452 155.331 35.1083C156.244 34.2601 156.701 33.1744 156.701 31.8512V30.8164H151.846C150.65 30.8164 149.743 31.0652 149.122 31.5628C148.513 32.0604 148.209 32.739 148.209 33.5985C148.209 34.4467 148.513 35.1196 149.122 35.6173C149.743 36.1149 150.594 36.3637 151.677 36.3637ZM151.152 39.3155C149.303 39.3155 147.803 38.7613 146.652 37.653C145.502 36.5446 144.927 35.1932 144.927 33.5985C144.927 31.9586 145.536 30.5958 146.754 29.5101C147.983 28.4131 149.68 27.8646 151.846 27.8646H156.701V26.9824C156.701 25.8515 156.34 24.9637 155.618 24.319C154.908 23.6631 153.938 23.3351 152.709 23.3351C151.716 23.3351 150.91 23.55 150.289 23.9798C149.669 24.4095 149.263 24.9524 149.071 25.6083H145.62C145.97 24.0815 146.793 22.8036 148.09 21.7744C149.399 20.7339 150.938 20.2137 152.709 20.2137C154.998 20.2137 156.786 20.8357 158.071 22.0798C159.357 23.3125 160 24.9467 160 26.9824V38.9762H157.226L156.87 36.7199H156.701C156.306 37.3872 155.607 37.9866 154.603 38.5182C153.6 39.0497 152.449 39.3155 151.152 39.3155Z"
                  fill="#D7E3FF"
                />
              </svg>
            </div>
          </div>
          <div
            style={{
              display: 'flex',
              flexWrap: 'wrap',
              justifyContent: 'center',
              padding: '20px 40px',
              fontSize: 50,
              width: 'auto',
              maxWidth: 1100,
              textAlign: 'center',
              backgroundColor: '#0F172A',
              color: '#F8FAFC',
              lineHeight: 1.4,
              border: '4px',
              borderRadius: '30px',
              borderColor: '#1D283A',
              fontWeight: 800,
              overflow: 'hidden',
            }}
          >
            {text}
          </div>

          <div
            style={{
              width: '100%',
              display: 'flex',
              justifyContent: 'flex-end',
            }}
          >
            <div
              style={{
                display: 'flex',
                color: '#F8FAFC',
                fontSize: 30,
                width: 'auto',
                textAlign: 'right',
              }}
            >
              By @{username}
            </div>
          </div>
        </div>
      </div>
    ),
    {
      width: 1200,
      height: 630,
      emoji: 'twemoji',
    }
  );
}
